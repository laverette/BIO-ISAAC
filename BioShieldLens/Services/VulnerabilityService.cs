using BioShieldLens.Data;
using BioShieldLens.Models;
using Microsoft.EntityFrameworkCore;

namespace BioShieldLens.Services;

public class VulnerabilityService : IVulnerabilityService
{
    private readonly BioShieldDbContext _context;
    private readonly IAiClassificationService _aiService;
    private readonly ILogger<VulnerabilityService> _logger;

    public VulnerabilityService(
        BioShieldDbContext context,
        IAiClassificationService aiService,
        ILogger<VulnerabilityService> logger)
    {
        _context = context;
        _aiService = aiService;
        _logger = logger;
    }

    public async Task<List<Vulnerability>> GetVulnerabilitiesByPriorityAsync(string priority)
    {
        return await _context.Vulnerabilities
            .Where(v => v.UrgencyLevel == priority)
            .OrderByDescending(v => v.BioImpactScore ?? 0)
            .ThenByDescending(v => v.DateDiscovered)
            .ToListAsync();
    }

    public async Task<List<Vulnerability>> GetAllVulnerabilitiesAsync()
    {
        return await _context.Vulnerabilities
            .OrderByDescending(v => v.DateDiscovered)
            .ToListAsync();
    }

    public async Task<Vulnerability?> GetVulnerabilityByIdAsync(int id)
    {
        return await _context.Vulnerabilities.FindAsync(id);
    }

    public async Task UpdateVulnerabilityClassificationAsync(int id)
    {
        var vulnerability = await _context.Vulnerabilities.FindAsync(id);
        if (vulnerability == null) return;

        var classification = await _aiService.ClassifyVulnerabilityAsync(vulnerability);

        vulnerability.BioImpactScore = classification.BioImpactScore;
        vulnerability.HumanImpactScore = classification.HumanImpactScore;
        vulnerability.UrgencyLevel = classification.UrgencyLevel;
        vulnerability.AffectedSector = classification.AffectedSector;
        vulnerability.IntelNotes = classification.IntelNotes;
        vulnerability.UpdatedAt = DateTime.UtcNow;

        await _context.SaveChangesAsync();
    }

    public async Task<Dictionary<string, int>> GetVulnerabilityStatsAsync()
    {
        var stats = new Dictionary<string, int>
        {
            ["Total"] = await _context.Vulnerabilities.CountAsync(),
            ["Critical to Act Now"] = await _context.Vulnerabilities.CountAsync(v => v.UrgencyLevel == "Critical to Act Now"),
            ["Monitor"] = await _context.Vulnerabilities.CountAsync(v => v.UrgencyLevel == "Monitor"),
            ["Low Priority"] = await _context.Vulnerabilities.CountAsync(v => v.UrgencyLevel == "Low Priority")
        };

        return stats;
    }
}

